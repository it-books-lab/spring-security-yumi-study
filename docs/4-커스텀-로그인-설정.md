# 4강. 커스텀 로그인 설정: formLogin()으로 리다이렉트 설정

## 목표
: 3강까지만 설정해두면 비로그인 상태에서 /admin에 접속했을 때 로그인 화면이 리다이렉팅되지 않고, 403 에러가 발생한다. 이때 리다이렉트를 설정하기 위해서 formLogin을 작성한다.

```html
- login.mustache

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    login page
    <hr>
    <form action="/loginProc" method="post" name="loginForm">
        <input id="username" type="text" name="username" placeholder="id"/>
        <input id="password" type="password" name="password" placeholder="password"/>
        <input type="submit" value="login"/>
    </form>
</body>
</html>
```
- `<form action="/loginProc" method="post" name="loginForm">`
- `post` 방식으로 `/loginProc`로 로그인 폼을 전송

```java
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class LoginController {

    @GetMapping("/login")
    public String loginP() {

        return "login";
    }
}
```

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception{

        http
                .authorizeHttpRequests((auth) -> auth
                        .requestMatchers("/", "/login", "/loginProc").permitAll()
                        .requestMatchers("/admin").hasRole("ADMIN")
                        .requestMatchers("/my/**").hasAnyRole("ADMIN", "USER")
                        .anyRequest().authenticated()
                );

        http
                .formLogin((auth) -> auth.loginPage("/login") // 로그인 페이지
                        .loginProcessingUrl("/loginProc") // 로그인 form을 보낼 url
                        .permitAll() // 모든 유저에게 허용
                );

        http
                .csrf((auth) -> auth.disable());
                // csrf가 자동으로 설정되어 있는데, csrf 설정이 되어있으면 로그인 폼 보낼 때 csrf 토큰도 보내줘야 함
                // 따라서, 일단 disable()해둠.

        return http.build();
    }
}
```

```java
        http
                .formLogin((auth) -> auth.loginPage("/login") // 로그인 페이지
                        .loginProcessingUrl("/loginProc") // 로그인 form을 보낼 url
                        .permitAll() // 모든 유저에게 허용
                );
```
- 위의 설정을 통해 비로그인 상태에서 로그인이 필요한 api url을 호출 시 로그인 페이지를 리다이렉트 할 수 있다!



